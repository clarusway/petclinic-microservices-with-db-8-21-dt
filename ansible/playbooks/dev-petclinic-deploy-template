- hosts: role_master
  tasks:
  
  - name: copy the kubernetes yaml files
    become: yes
    copy: 
      src: ${WORKSPACE}/k8s
      dest: /home/ubuntu/k8s

  - name: login ecr
    shell: aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}

  - name: deploy petclinic application
    shell: |
      kubectl delete secret regcred -n petclinic-staging-ns || true
      kubectl create secret generic regcred -n petclinic-staging-ns \
        --from-file=.dockerconfigjson=$JENKINS_HOME/.docker/config.json \
        --type=kubernetes.io/dockerconfigjson
      kubectl apply -k k8s/dev/